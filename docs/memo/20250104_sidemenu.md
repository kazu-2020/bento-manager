# 割引・サイドメニュー・返品（仕様）仕様提案

本ドキュメントは、現時点で確定した  
**割引・サイドメニュー（サラダ）・返品（仕様A：取消→再販売）**  
に関する仕様をまとめたものです。

---

## 1. 基本方針（全体）

- **Sale（販売）は不変**
  - 一度作成した Sale は編集しない
- **価格や条件が変わる訂正は「取消（void）→再販売」**
- **配賦は行わない**
- **価格が異なる場合は SaleItem を分割して作成**
- **返金額は差額で管理する**
- 割引条件・セット条件は **再販売時に再評価**する

---

## 2. 商品カテゴリの前提

### Bento（弁当）
- 単体価格のみを持つ

### SideMenu（サイドメニュー）
- 現時点で特別な振る舞いがあるのは **サラダのみ**
- 将来、他のサイドメニューが追加される場合は個別にルールを追加する

---

## 3. サラダの価格仕様

### 3.1 価格体系

サラダは **2種類の価格**を持つ。

| 種別 | 金額 | 管理方法 |
|---|---|---|
| 通常価格 | 250円 | CatalogPrice(kind: `regular`) |
| セット価格 | 150円 | CatalogPrice(kind: `bundle`) |

---

### 3.2 セット価格適用条件

- **弁当 1 個につき、サラダ 1 個まで**セット価格を適用
- 適用数量は以下で決定する：

```text
セット適用数 = min(弁当数量, サラダ数量)

例
	•	弁当1・サラダ3
→ サラダ150円 ×1、250円 ×2
	•	弁当2・サラダ3
→ サラダ150円 ×2、250円 ×1
```

---

### 3.3 実装ルール
	•	サラダは 単価ごとに SaleItem を分割
	•	セット価格は「割引」ではなく 価格ルール
	•	合計金額からの値引き・按分は行わない

---

## 4. クーポン仕様

### 4.1 クーポン内容

•	50円割引クーポン
•	弁当 1 個につき 1 枚まで使用可能

---

### 4.2 クーポン適用方法

•	クーポンは 弁当の単価を −50円する
•	クーポン適用分と非適用分は SaleItem を分割して表現する

例
	•	弁当550円 ×1、クーポン1枚
→ 弁当500円 ×1
	•	弁当550円 ×2、クーポン1枚
→ 弁当500円 ×1、550円 ×1

---

## 5. SaleItem の確定ルール

### 5.1 SaleItem が保持する情報

•	catalog_id
•	quantity
•	unit_price（販売時に確定した単価）
•	line_total = unit_price × quantity

※ 金額計算は 常に unit_price を正とする

---

### 5.2 SaleItem 分割例

弁当1・サラダ3・クーポン1枚

商品	単価	数量
弁当（クーポン適用）	500	1
サラダ（セット）	150	1
サラダ（通常）	250	2

---

## 6. CatalogPricingRule の役割

CatalogPricingRule は 価格を持たない。

責務
•	どの商品（target_catalog）に
•	どの価格種別（price_kind）を
•	どんな条件（trigger_category）で
•	何個まで適用するか（max_per_trigger）

を定義する。

サラダのルール例

target_catalog_id = サラダ
price_kind        = bundle
trigger_category  = bento
max_per_trigger   = 1

---

## 7. 返品・返金仕様（仕様A）

### 7.1 基本ルール
	•	部分返金は行わない
	•	返品・訂正は 取消（void）→再販売で対応する
	•	返金額は 差額で計算する


### 7.2 返品フロー
1.	元の Sale を void（取消）
2.	元 Sale の全 SaleItem 数量を在庫に戻す
3.	残す商品だけで 新しい Sale を作成
  •	価格ルール・クーポンを再評価
4.	在庫を再度減算
5.	差額を Refund として記録

### 7.3 仕様を満たす具体例

販売
•	弁当 550円 ×1
•	サラダ 150円 ×1（セット成立）

合計：700円

弁当を返品
	•	元 Sale を void
	•	新 Sale：サラダ単品 → 250円
	•	返金額：

700 − 250 = 450円

✅ 仕様どおり 450円返金

## 8. 在庫への影響
•	販売時
•	DailyInventory.stock -= 販売数量
•	取消（void）時
•	DailyInventory.stock += 元Saleの数量
•	再販売時
•	DailyInventory.stock -= 新Saleの数量

## 9. やらないこと（明示的非対応）
•	Sale の部分編集
•	割引額の按分
•	SetDiscount の使用
•	割引条件の再配分
•	部分返金（行単位返金）

## 10. 一文まとめ

価格や条件が変わる訂正はすべて「取消→再販売」で扱い、
単価が確定した SaleItem だけを正とする設計が確定

⸻

```mermaid
erDiagram
    Admin ||--o{ Employee : manages
    Admin {
        int id PK
        string email UK
        string password_hash
        string name
    }
    Employee {
        int id PK
        string email UK
        string password_hash
        string name
    }

    %% --- Catalog (delegated_type) ---
    Catalog ||--|| Bento : catalogable
    Catalog ||--|| SideMenu : catalogable
    Catalog ||--o{ CatalogPrice : has
    Catalog ||--o| CatalogDiscontinuation : has
    Catalog ||--o{ DailyInventory : has
    Catalog ||--o{ CatalogPricingRule : has

    Catalog {
        int id PK
        string catalogable_type
        int catalogable_id
        string name UK
        string category  "bento | side_menu | ..."
    }

    Bento {
        int id PK
        string description
    }

    SideMenu {
        int id PK
        string description
    }

    %% --- Price table (supports multiple kinds: regular/bundle) ---
    CatalogPrice {
        int id PK
        int catalog_id FK
        string kind        "regular | bundle"
        int price
        datetime effective_from
        datetime effective_until
    }

    CatalogDiscontinuation {
        int id PK
        int catalog_id FK UK
        datetime discontinued_at
        string reason
    }

    %% --- Pricing rule (selects which CatalogPrice.kind to use under conditions) ---
    CatalogPricingRule {
        int id PK
        int target_catalog_id FK      "price changes for this item (e.g., Salad)"
        string price_kind             "bundle"
        string trigger_category       "bento"
        int max_per_trigger           "1"
        date valid_from
        date valid_until
        datetime created_at
        datetime updated_at
    }

    CatalogPricingRule ||--|| Catalog : targets

    %% --- Discounts (Coupon only; applies per bento item) ---
    Discount ||--|| Coupon : discountable
    Discount ||--o{ SaleDiscount : has_many

    Discount {
        int id PK
        string discountable_type
        int discountable_id
        string name
        string discount_type
        int discount_value
        date valid_from
        date valid_until
    }

    Coupon {
        int id PK
        string description
        int amount_per_unit           "50"
        int max_per_bento_quantity    "1 per bento"
    }

    SaleDiscount ||--|| Sale : belongs_to
    SaleDiscount ||--|| Discount : belongs_to

    SaleDiscount {
        int id PK
        int sale_id FK
        int discount_id FK
        int discount_amount
        datetime created_at
        datetime updated_at
    }

    %% --- Inventory (daily quantity-based) ---
    DailyInventory ||--|| Catalog : belongs_to

    DailyInventory {
        int id PK
        int catalog_id FK
        date inventory_date
        int stock
        int reserved_stock
        int lock_version
    }

    %% --- Sales (SaleItem stores applied unit_price; split rows by price) ---
    Sale ||--o{ SaleItem : has_many
    Sale ||--o{ SaleDiscount : has_many
    Sale ||--o| Employee : sold_by
    Sale ||--o| Sale : corrected_from

    Sale {
        int id PK
        datetime sale_datetime
        string customer_type
        int total_amount
        int final_amount
        int employee_id FK

        string status               "completed | voided"
        datetime voided_at
        int voided_by_employee_id FK
        string void_reason

        int corrected_from_sale_id FK  "nullable; points to original sale when this is a corrected sale"
    }

    SaleItem ||--|| Sale : belongs_to
    SaleItem ||--|| Catalog : belongs_to
    SaleItem ||--o| CatalogPrice : references_base_price

    SaleItem {
        int id PK
        int sale_id FK
        int catalog_id FK
        int catalog_price_id FK
        int quantity
        int unit_price              "applied price (e.g., bento-50, salad 150/250)"
        int line_total              "unit_price * quantity"
        datetime sold_at
        datetime created_at
        datetime updated_at
    }

    %% --- Refunds (delta refund between original sale and corrected sale) ---
    Refund ||--|| Sale : original_sale
    Refund ||--|| Sale : corrected_sale
    Refund ||--o| Employee : processed_by

    Refund {
        int id PK
        int original_sale_id FK
        int corrected_sale_id FK
        int employee_id FK
        datetime refund_datetime
        int amount                 "original.final_amount - corrected.final_amount"
        string reason
        datetime created_at
        datetime updated_at
    }

    %% --- Additional order (restock record) ---
    AdditionalOrder ||--|| Catalog : belongs_to
    AdditionalOrder ||--o| Employee : ordered_by

    AdditionalOrder {
        int id PK
        int catalog_id FK
        date order_date
        time order_time
        int quantity
        int employee_id FK
    }
```
