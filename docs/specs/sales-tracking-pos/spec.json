{
  "feature_name": "sales-tracking-pos",
  "created_at": "2026-01-03T13:21:00+09:00",
  "updated_at": "2026-01-28T16:00:00+09:00",
  "language": "ja",
  "phase": "tasks-generated",
  "approvals": {
    "requirements": {
      "generated": true,
      "approved": true
    },
    "design": {
      "generated": true,
      "approved": true
    },
    "tasks": {
      "generated": true,
      "approved": false
    }
  },
  "ready_for_implementation": false,
  "notes": "2026-01-04: 価格ルール(CatalogPricingRule)、返品・返金処理(Void/Refund)、SaleItem.unit_price/line_total を追加。SetDiscount を削除し、セット価格は CatalogPricingRule で管理。Bento/SideMenu テーブルを削除し、Catalog.category enum で管理。SaleDiscount は監査トレイルとして維持。memo/20250104_sidemenu.md の仕様を反映。2026-01-04 15:30: Requirement 13-15 を追加（クーポン管理、サラダ条件付き価格、返品・返金処理の詳細要件）。2026-01-04 16:00: design.md 更新完了。Requirements Traceability と Components Summary に Requirement 13-15 を反映。既存設計で詳細要件をほぼカバー済み。2026-01-04 16:30: Discount テーブルから discount_type/discount_value を削除（常に固定額のため）、ER図に詳細コメント追加、Business Rules 更新。2026-01-04 17:00: 販売先（ロケーション）の概念を追加。Requirement 16（販売先管理）を追加し、Requirement 2-4 を更新（販売先ごとの在庫管理・販売記録・在庫確認）。2026-01-04 17:30: design.md 更新完了。Location モデルを追加（status enum で配達状態管理: active/inactive に変更）、DailyInventory と Sale と AdditionalOrder に location_id FK を追加、ユニーク制約を (location_id, catalog_id, inventory_date) に変更。2026-01-04 18:00: tasks.md 生成完了（-y フラグで design を自動承認）。40 major tasks, 127 sub-tasks、並列実行可能タスク 45 個、全 16 要件カバー。Phase 1-20 に分割（Foundation → Auth → Domain Models → Controllers → Views → Testing → Integration）。2026-01-05 00:00: Requirement 9 更新。ユーザーロールを明確化（Employee = オーナー + 販売員、Admin = システム開発者）。認可機能は不要で、Admin の UI 管理機能は提供しない（Rails console のみ）。Background セクション追加、Acceptance Criteria を 13 項目に拡充。2026-01-05 01:00: design.md 更新完了。Authentication Domain セクション追加（Admin と Employee の詳細設計）、Requirements Traceability 更新（9.1-9.13 に拡張、AdminEmployeesController を EmployeesController に変更）、Components Summary 更新（認可不要、Rails console のみを明記）、research.md に決定12 追加。2026-01-05 02:00: Requirement 9 再更新。Employee管理画面へのアクセス制限を明示（Admin のみアクセス可能、Employee は 403 エラー）。Background に例外を追記、Acceptance Criteria を 15 項目に拡張（AC 14-15 追加）。2026-01-05 03:00: design.md 再更新完了。Requirements Traceability を 9.1-9.15 に拡張、Components Summary 更新（Admin: Employee管理画面へのアクセス権限、Employee: Employee管理画面はアクセス不可）、Employee Implementation Notes に認可制御詳細を追加（before_action :require_admin_auth、current_user.is_a?(Admin) 判定、403 エラーハンドリング）、research.md に決定13 追加。2026-01-05 04:00: 認可制御実装を rodauth-rails 公式機能に変更。research.md の決定13 更新（`rodauth(:employee).logged_in?` で Employee 判定、`rodauth(:admin).require_account` で Admin 認証強制）、design.md の Employee Implementation Notes 更新（rodauth-rails の複数アカウント設定を使用）、参考資料追加（rodauth-rails ドキュメント）。2026-01-05 05:00: tasks.md 更新。タスク 2.3（Employee管理画面の認可制御実装）、15.5（EmployeesController 実装）、23.1（Employee 管理画面実装）を更新し、Requirement 9.14-9.15 を反映。AdminEmployeesController を EmployeesController に変更。rodauth-rails 公式機能（`rodauth(:employee).logged_in?`、`rodauth(:admin).require_account`）を使用した認可制御パターンを追加。2026-01-05 14:00: tasks.md 承認完了（-y フラグで自動承認）。タスク 1.1, 1.2 完了済み。実装フェーズ準備完了（ready_for_implementation: true）。2026-01-07 12:00: Requirement 13 明確化（クーポン適用条件: ラインアイテム数 → 弁当 quantity 合計）。design.md の Coupon#applicable? と #max_applicable_quantity を quantity ベースに変更。research.md に決定14 追加。tasks.md の Task 10.3 を更新（quantity ベースの明確化、Requirements 13.2, 13.8 追加）。2026-01-08 12:00: SaleItem の after_create コールバックを Sales::Recorder PORO に移動。design.md 更新（Sales::Recorder セクション追加、SaleItem を純粋データモデルに変更、System Flows と Error Handling を更新）。research.md に決定15 追加。結合度低減とテスト容易性向上。2026-01-10 14:30: Requirement 17-19（価格存在検証）を追加。tasks.md 更新: Phase 7b 追加（Task 41-43: Catalog::PriceValidator、Catalog::PricingRuleCreator、Admin画面警告表示）、テストタスク追加（35.5、35.6、37.5、37.6）。43 major tasks、145 sub-tasks、19/19 requirements カバー。2026-01-10 17:00: Catalog::PriceValidator と Sales::PriceCalculator の責務分担をリファクタリング（決定18）。PriceValidator を「(catalog_id, kind, at) の価格存在検証」の薄い部品に変更、「何の kind が必要か」の決定は PriceCalculator が担当。Sales::Recorder は PriceValidator を直接呼び出さず、PriceCalculator 経由で価格存在検証を実行。二重管理を解消しテスト容易性向上。2026-01-27: Requirement 11（オフライン対応）を削除（不要になったため）。旧 Requirement 12-19 を Requirement 11-18 に繰り上げ。全 18 要件。制約条件のネットワーク制約の記述も削除。2026-01-27: design.md 更新完了。オフライン関連コンポーネント（OfflineSyncController, ServiceWorker, Sales::OfflineSynchronizer）を削除、オフライン同期フロー削除、Technology Stack から Offline 行削除、Requirements Traceability の番号を旧12-19→11-18 に繰り上げ、Components Summary の Req Coverage 番号更新、Testing Strategy からオフライン関連テスト削除、Migration Strategy から Phase 7（オフライン対応）削除。research.md の技術選定まとめからオフライン行を削除。2026-01-27: design review 実施（GO 判定、条件付き）。2つの指摘事項を修正: (1) Location の論理削除パターンを status: active/inactive に統一（Physical Data Model の deleted_at 記述を修正、Requirements Traceability の Location#soft_delete を Location#deactivate に変更）。(2) Sales::Refunder PORO を追加（返品・返金処理の責務を SalesController から分離）。Architecture 図、Components Summary、返品・返金フロー図、Requirements Traceability、Sale モデル（void! → mark_as_voided!）、Unit Tests、Integration Tests、Error Handling を更新。Location の Req Coverage を 16.1-16.7 → 15.1-15.7 に修正（前回の繰り上げ漏れ）。2026-01-27 12:00: tasks.md 再生成完了。オフライン削除・要件繰り上げ・Sales::Refunder 追加・Sale#mark_as_voided! 変更を反映。42 major tasks、135 sub-tasks、18/18 requirements カバー。旧 Task 41-43 を Task 11-13 に再配置、新 Task 13（Sales::Refunder）追加、オフラインタスク（旧30, 31, 35.4, 37.4）削除。2026-01-28: Requirement 2 の AC 5（在庫一覧表示）と AC 6（販売先フィルタリング）を削除。POS フロー内で在庫登録を行う運用のため、独立した在庫管理画面は不要と判断。Requirement 2 は AC 1-4 の4項目に簡素化。2026-01-28: tasks.md 更新完了。Requirement 2 の AC 5, 6 削除に伴い、独立した在庫管理画面関連タスクを削除（旧 Task 18.4, 25, 38.4）。POS フロー内の在庫登録は Pos::Locations::DailyInventoriesController として Task 27.1 で実装済み。タスク番号を繰り上げ。41 major tasks、128 sub-tasks、18/18 requirements カバー。2026-01-28 16:00: Task 28（リアルタイム在庫確認画面）を削除。Requirement 4 の全 AC は POS 画面に統合済み（商品カードに在庫バッジ表示、ghost form による最新在庫取得、売り切れ視覚識別、販売先選択による切り替え）。タスク番号を旧 29→28, ...旧 41→40 に繰り上げ。40 major tasks、125 sub-tasks、18/18 requirements カバー。"
}


