# Requirements Document

## Project Description (Input)
@docs/memo/20251230_hearing_memo.md のヒアリング内容を元にシステムを作成したい

## Introduction

個人経営の弁当屋における複数の販売先（例: 市役所）での訪問販売業務を支援するシステム。主な目的は、販売先ごとに販売データを蓄積し、追加発注時の意思決定を定量的な判断軸で行えるようにすることである。副次的に、販売時の計算負荷を軽減し、オーナーがデータを活用できるよう可視化機能を提供する。

**ステークホルダー**:
- **販売員**: 50代女性、訪問販売担当（スマホ利用）
- **オーナー**: 弁当製造・追加発注判断（PC利用）
- **顧客**: 市役所職員・一般市民

**制約条件**:
- 訪問販売先ではスマホ利用（ネットワーク制約あり）
- 弁当製造施設ではPC利用可能
- 追加発注可能な弁当は「日替わり弁当A」のみ
- 弁当のレパートリーは1日あたり約6種類
- 複数の販売先を管理し、販売先ごとに在庫を管理する

## Requirements

### Requirement 1: 弁当商品マスタ管理

**Objective:** As a オーナー, I want 弁当商品情報（商品名、税込価格、カテゴリ）を登録・編集・削除できる, so that 日々変わる弁当のレパートリーに対応できる

#### Acceptance Criteria
1. When オーナーが新規弁当商品を登録する, the システム shall 商品名、税込価格、カテゴリ（日替わりA/日替わりB/その他）を入力フォームで受け付ける
2. When オーナーが弁当商品情報を編集する, the システム shall 既存の商品情報を更新する
3. When オーナーが弁当商品を削除する, the システム shall 該当商品を論理削除する（過去の販売データとの整合性を保つ）
4. The システム shall 弁当商品マスタを一覧表示する機能を提供する
5. The システム shall 税込価格を正の整数で管理する

### Requirement 2: 販売先ごとの在庫登録

**Objective:** As a オーナー, I want 販売先・販売日ごとに各弁当の初期在庫数を登録できる, so that 各販売先に持っていく弁当の数を記録できる

#### Acceptance Criteria
1. When オーナーが販売日の在庫を登録する, the システム shall 販売先、日付、弁当商品、初期数量を入力フォームで受け付ける
2. When オーナーが同一販売先・同一日付・同一商品の在庫を登録する, the システム shall エラーメッセージを表示し登録を拒否する
3. When オーナーが在庫登録を完了する, the システム shall 販売員がその販売先のその日の在庫情報を閲覧できる状態にする
4. The システム shall 在庫数を正の整数で管理する
5. The システム shall 販売先・販売日ごとの在庫登録状況を一覧表示する
6. When オーナーが在庫一覧を閲覧する, the システム shall 販売先でフィルタリングできる機能を提供する

### Requirement 3: 販売記録（POS機能）

**Objective:** As a 販売員, I want 販売時に弁当商品と数量を選択して合計金額を自動計算できる, so that 暗算や電卓を使わずに正確な会計ができる

#### Acceptance Criteria
1. When 販売員が弁当商品と数量を選択する, the システム shall 選択された商品の単価と数量から小計を計算する
2. When 販売員が複数の弁当商品を選択する, the システム shall すべての小計を合算して合計金額を表示する
3. When 販売員が販売を確定する, the システム shall 販売先、販売日時、顧客区分（職員/一般市民）、商品、数量、合計金額を記録する
4. When 販売が確定される, the システム shall 該当販売先の該当商品の残在庫数を減算する
5. The システム shall スマホでの操作に最適化されたUIを提供する
6. The システム shall 販売員が選択した販売先の当日の在庫がある弁当のみを選択可能にする
7. If 在庫数を超える数量が選択される, then the システム shall エラーメッセージを表示し販売を拒否する
8. When 販売員が販売画面にアクセスする, the システム shall 販売先を選択するフォームを提供する

### Requirement 4: リアルタイム在庫確認

**Objective:** As a 販売員, I want 販売先ごとに現在の弁当の残在庫数をリアルタイムで確認できる, so that 追加発注の判断材料として使える

#### Acceptance Criteria
1. The システム shall 販売員画面に販売員が選択した販売先の各弁当の現在在庫数を表示する
2. When 販売が記録される, the システム shall その販売先の在庫表示を即座に更新する
3. The システム shall 在庫数を弁当商品ごとに区分して表示する
4. The システム shall 在庫がゼロになった弁当を視覚的に識別できるようにする
5. When 販売員が販売先を変更する, the システム shall 表示される在庫を選択した販売先のものに切り替える

### Requirement 5: 追加発注記録

**Objective:** As a オーナー, I want 追加発注した弁当の数量と時刻を記録できる, so that 追加発注の履歴とそのタイミングを把握できる

#### Acceptance Criteria
1. When オーナーまたは販売員が追加発注を記録する, the システム shall 日付、弁当商品、追加数量、発注時刻を記録する
2. When 追加発注が記録される, the システム shall 該当商品の在庫数に追加数量を加算する
3. The システム shall 追加発注可能な弁当を「日替わり弁当A」に限定する
4. When 追加発注が記録される, the システム shall 現在時刻を自動的に記録する
5. The システム shall 追加発注履歴を一覧表示する

### Requirement 6: 販売データ分析（追加発注支援）

**Objective:** As a 販売員, I want 過去の販売データから追加発注の推奨数を確認できる, so that 定量的な根拠に基づいて追加発注の判断ができる

#### Acceptance Criteria
1. When 販売員が追加発注支援機能にアクセスする, the システム shall 過去の同一曜日・同一時間帯の販売実績を集計して表示する
2. When 追加発注支援機能が実行される, the システム shall 現在時刻から販売終了時刻（13:00）までの予測販売数を算出する
3. The システム shall 予測販売数と現在在庫数から推奨追加発注数を提示する
4. The システム shall 過去データが不足している場合は警告メッセージを表示する
5. Where 過去4週間以上のデータが存在する, the システム shall 平均値と標準偏差を用いた統計的推定を行う

### Requirement 7: 販売実績の日次レポート

**Objective:** As a オーナー, I want 1日の販売実績を顧客区分別・弁当別に確認できる, so that どの弁当がどれくらい売れたかを把握できる

#### Acceptance Criteria
1. When オーナーが日次レポートを閲覧する, the システム shall 指定日の販売実績を弁当商品別に集計して表示する
2. The システム shall 顧客区分（職員/一般市民）ごとの販売数を区別して表示する
3. The システム shall 各弁当の販売数、販売金額、売上合計を表示する
4. The システム shall 初期在庫数、追加発注数、最終在庫数を表示する
5. When オーナーが日付範囲を指定する, the システム shall 期間内の販売実績をまとめて表示する

### Requirement 8: 販売データの可視化

**Objective:** As a オーナー, I want 販売データをグラフで可視化できる, so that 販売傾向を直感的に把握できる

#### Acceptance Criteria
1. When オーナーがダッシュボードにアクセスする, the システム shall 直近4週間の売上推移を折れ線グラフで表示する
2. The システム shall 弁当商品別の販売数を棒グラフで表示する
3. The システム shall 顧客区分（職員/一般市民）別の売上構成比を円グラフで表示する
4. The システム shall 曜日別の販売傾向をグラフで表示する
5. When オーナーがグラフの期間を変更する, the システム shall 指定期間のデータで再描画する

### Requirement 9: 認証とユーザー管理

**Objective:** As a システム開発者, I want EmployeeとAdminの認証を管理できる, so that 業務ユーザー（オーナー・販売員）が安全にシステムにアクセスでき、デバッグや運用サポートが可能になる

**Background:**
- Employee: オーナーと販売員を一律で扱う業務ユーザー（機能的な区別なし）
- Admin: システム開発者のみ（デバッグ・運用サポート用）
- 現状は販売員（母）のみが利用想定のため、一般的な業務機能では認可機能（権限制御）は不要
- EmployeeとAdminは想定されるすべての業務機能を利用可能
- **例外**: Employee管理画面（CRUD）はAdminのみがアクセス可能

#### Acceptance Criteria
1. When EmployeeまたはAdminがログインする, the システム shall メールアドレスとパスワードで認証する
2. The システム shall ログイン画面をEmployeeとAdmin共通で提供する
3. When AdminがEmployeeを登録する, the システム shall メールアドレス、パスワード、氏名を入力フォームで受け付ける
4. The システム shall Employee一覧画面でEmployeeを表示する
5. When AdminがEmployeeを編集する, the システム shall メールアドレス、パスワード、氏名を更新する
6. When AdminがEmployeeを削除する, the システム shall 該当Employeeを削除する
7. The システム shall すべての認証済みEmployeeにすべての業務機能へのアクセスを許可する（認可制御なし）
8. The システム shall すべての認証済みAdminにすべての機能へのアクセスを許可する
9. The システム shall Adminの登録・編集・削除機能をUIとして提供しない（Rails consoleでの操作を想定）
10. If 未認証ユーザーが保護されたページにアクセスする, then the システム shall ログインページにリダイレクトする
11. When ユーザーがログアウトする, the システム shall セッションを破棄しログイン画面にリダイレクトする
12. The システム shall パスワードをハッシュ化して安全に保存する
13. The システム shall EmployeeとAdminを別テーブルで管理する（異なるユーザータイプ）
14. If EmployeeがEmployee管理画面（一覧・登録・編集・削除）にアクセスしようとする, then the システム shall アクセスを拒否し403エラーを返す
15. The システム shall AdminのみがEmployee管理画面にアクセスできるように認可制御を実装する

### Requirement 10: レスポンシブデザイン

**Objective:** As a 販売員およびオーナー, I want スマホとPCの両方で快適に操作できる, so that 現場でもオフィスでも利用できる

#### Acceptance Criteria
1. The システム shall スマホ画面（画面幅480px以下）で表示が崩れないようにレイアウトする
2. The システム shall タッチ操作に適したボタンサイズ（最小44x44px）を提供する
3. The システム shall PC画面（画面幅1024px以上）でグラフやテーブルを効率的に配置する
4. The システム shall フォント可読性を確保する（最小14px、重要情報は16px以上）
5. The システム shall Tailwind CSSのレスポンシブクラスを活用する

### Requirement 11: オフライン対応

**Objective:** As a 販売員, I want ネットワークが不安定でも販売記録を継続できる, so that 訪問販売先でも安定して業務を遂行できる

#### Acceptance Criteria
1. When ネットワークが切断される, the システム shall 販売記録をローカルストレージに一時保存する
2. When ネットワークが復旧する, the システム shall ローカルストレージのデータをサーバーに自動同期する
3. If 同期中にエラーが発生する, then the システム shall エラー内容を表示し手動再試行を可能にする
4. The システム shall オフライン状態であることを視覚的に通知する
5. While オフライン状態である, the システム shall 在庫確認と販売記録機能のみ利用可能にする

### Requirement 12: データ整合性とパフォーマンス

**Objective:** As a 開発者, I want データの一貫性を保ち高速なレスポンスを提供できる, so that ユーザーがストレスなくシステムを利用できる

#### Acceptance Criteria
1. The システム shall 販売記録時に楽観的ロックまたは悲観的ロックで在庫の同時更新を制御する
2. The システム shall データベーストランザクションで販売記録と在庫更新の原子性を保証する
3. The システム shall ページロード時間を3秒以内に抑える（モバイル4G環境）
4. The システム shall 頻繁にアクセスされるデータ（当日在庫）にキャッシュを適用する
5. The システム shall データベースインデックスを販売日・弁当商品IDに設定する

### Requirement 13: 割引（クーポン）管理と適用

**Objective:** As a 販売員, I want 会計時にクーポンを適用して正しい割引額を自動計算できる, so that 手計算なしで正確な会計ができる

#### Acceptance Criteria
1. When 販売員が会計時にクーポン枚数を入力する, the システム shall クーポン枚数の入力フォームを提供する
2. When クーポン枚数が入力される, the システム shall 弁当数量を超えるクーポン枚数を受け付けない
3. The システム shall クーポン1枚あたり50円の割引を適用する
4. When クーポンが適用される, the システム shall クーポン適用後の合計金額を自動で計算し表示する
5. The システム shall クーポンの定義（割引額、適用条件）をマスタデータとして管理する
6. When 販売が確定される, the システム shall その販売で使用されたクーポン枚数を記録する
7. The システム shall オーナーがクーポン使用履歴を集計・監査できる機能を提供する
8. The システム shall 「弁当1個につき最大1枚」の適用条件をクーポンマスタで管理する
9. If 弁当数量が0でクーポン枚数が1以上入力される, then the システム shall エラーメッセージを表示し販売を拒否する

### Requirement 14: サイドメニュー（サラダ）の条件付き価格設定

**Objective:** As a 販売員, I want サラダの数量を入力するだけでセット価格と単品価格が自動適用される, so that 価格計算の手間なく正確な会計ができる

#### Acceptance Criteria
1. The システム shall サラダに通常価格（250円）とセット価格（150円）の2つの価格を設定する
2. When 販売員が弁当とサラダの数量を入力する, the システム shall セット価格の適用条件（弁当1個につきサラダ1個まで）を自動判定する
3. When 弁当1個とサラダ3個が選択される, the システム shall サラダ1個をセット価格150円、残り2個を単品価格250円で計算する
4. When 販売員が弁当数量とサラダ数量を入力する, the システム shall サラダの価格内訳（セット価格適用数、単品価格適用数）を表示する
5. The システム shall サラダのセット価格適用ルールをマスタデータとして管理する
6. The システム shall 将来的に別のサイドメニューで条件付き価格が必要になった場合、個別ルールを追加できる拡張性を持つ
7. When 弁当0個とサラダ1個が選択される, the システム shall サラダを単品価格250円で計算する
8. When 販売が確定される, the システム shall 各サラダの適用価格（150円または250円）を販売明細に記録する

### Requirement 15: 返品・返金処理（取消・再販売・差額返金）

**Objective:** As a 販売員, I want 返品時に正しい返金額が自動計算される, so that セット価格やクーポン条件が変わる場合でも正確な返金処理ができる

#### Acceptance Criteria
1. When 販売員が返品処理を実行する, the システム shall 元の販売を取消（無効化）する
2. When 元の販売が取消される, the システム shall 返品された商品の在庫を復元する
3. When 元の販売が取消される, the システム shall 残る商品のみで新規販売を作成する
4. When 新規販売が作成される, the システム shall セット価格とクーポンの適用条件を再評価する
5. When 再評価が完了する, the システム shall 元の販売金額と新規販売金額の差額を返金額として計算する
6. When 弁当550円+サラダ150円（セット）を購入後に弁当のみ返品する, the システム shall サラダを単品価格250円で再計算し、返金額450円を提示する
7. The システム shall 元の販売、新規販売、返金額の3つのトランザクションを記録する
8. The システム shall 取消された販売に「取消済み」フラグを設定し、参照用に保持する
9. When 返品処理が完了する, the システム shall 在庫数の整合性を保証する（返品商品が在庫に戻る）
10. The システム shall 返金履歴を監査可能な形で記録する
11. If 全商品を返品する, then the システム shall 全額返金として処理し新規販売を作成しない
12. When 部分返品が発生する, the システム shall 返金理由を記録できる機能を提供する

### Requirement 16: 販売先（ロケーション）管理

**Objective:** As a オーナー, I want 複数の販売先を登録・管理できる, so that 販売先ごとに在庫を管理し販売実績を把握できる

#### Acceptance Criteria
1. When オーナーが新規販売先を登録する, the システム shall 販売先名称を入力フォームで受け付ける
2. When オーナーが販売先情報を編集する, the システム shall 既存の販売先情報を更新する
3. When オーナーが販売先を削除する, the システム shall 該当販売先を論理削除する（過去の在庫データ・販売データとの整合性を保つ）
4. The システム shall 販売先一覧を表示する機能を提供する
5. The システム shall 各販売先にユニークなIDを付与する
6. The システム shall 販売先名称を必須項目として管理する
7. When 販売先が削除される, the システム shall 該当販売先に紐づく在庫登録や販売記録を継続して参照可能にする


