<div data-controller="ghost-form refund-cart"
     data-action="refund-cart:cartChanged->ghost-form#submit">
  <%# top-16 (4rem): navbar の高さ分オフセット %>
  <%# bottom-12: モバイルで Dock のスペースを確保 %>
  <div class="fixed inset-x-0 top-16 bottom-12 lg:bottom-0 lg:left-72 z-20 bg-base-200 flex flex-col">
    <%# 差額精算フォーム %>
    <%= form_with **form_with_options,
                  class: "flex flex-col flex-1 min-h-0",
                  data: { ghost_form_target: "originalForm" } do |f| %>
      <%= hidden_field_tag "sale_id", sale.id %>

      <div data-controller="tabs" class="flex flex-col flex-1 min-h-0">
        <%# 元の販売内容（折りたたみ） %>
        <div class="shrink-0 px-3 pt-2">
          <%= component "pos/refunds/original_sale_summary", sale: sale %>
        </div>

        <%# タブバー %>
        <div class="shrink-0 bg-base-200 px-4 pt-2">
          <div role="tablist" class="tabs tabs-lift">
            <% tab_items.each_with_index do |tab, i| %>
              <%= button_tag tab[:label], type: :button, role: :tab,
                    class: "tab min-h-12 flex-1 text-base font-medium #{"tab-active" if i == 0}",
                    data: { tabs_target: "tab", action: "tabs#select" } %>
            <% end %>
          </div>
        </div>

        <%# タブパネル（スクロール領域） %>
        <main class="flex-1 overflow-y-auto px-3 py-2 pb-48">
          <% tab_items.each_with_index do |tab, i| %>
            <div data-tabs-target="panel" <%= "hidden" unless i == 0 %>>
              <% case tab[:key] %>
              <% when :bento %>
                <div class="space-y-1">
                  <%= component "pos/refunds/corrected_cart_item", collection: bento_corrected_items %>
                </div>
              <% when :side_menu %>
                <div class="space-y-1">
                  <%= component "pos/refunds/corrected_cart_item", collection: side_menu_corrected_items %>
                </div>
              <% when :coupon %>
                <div class="space-y-1">
                  <%= component "pos/refunds/refund_coupon_card", collection: available_discounts, form: form %>
                </div>
              <% end %>
            </div>
          <% end %>

          <%# 精算内容 %>
          <div id="refund-preview" class="mt-4">
            <%= component "pos/refunds/settlement_summary", form: form, sale: sale %>
            <%= component "pos/refunds/refund_amount_display", form: form %>
          </div>
        </main>
      </div>

      <%# フッター %>
      <footer class="shrink-0 bg-base-100 border-t border-base-300">
        <div class="px-3 py-2 safe-area-pb">
          <div class="alert alert-warning py-2 px-3 mb-2">
            <svg class="w-5 h-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span class="text-sm"><%= t(".warning_message") %></span>
          </div>
          <%= component "pos/refunds/submit_button", form: form %>
        </div>
      </footer>
    <% end %>
  </div>

  <%# Ghost Form %>
  <%= component "pos/refunds/ghost_form", form: form, sale: sale, location: location %>

  <%# モバイル用フッターナビゲーション %>
  <%= component "pos/dock", location: location, current_path: helpers.request.path %>
</div>
